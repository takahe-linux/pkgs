# Maintainer: Alastair Hughes < hobbitalastair at yandex dot com>

# Package information
pkgname="linux-qemu"
_major_version='4.7'
_srcname="linux-${_major_version}"
pkgdesc="qemu kernel"
pkgver="${_major_version}.5"
pkgrel=1

# Additional information...
arch=('i586' 'mips')
url='http://www.kernel.org'
license=('GPL2')

# Dependency information
hostdepends=('bc' 'inetutils' "${_target_triplet}-gcc-static"
    "${_target_triplet}-binutils")
provides=('linux')
conflicts=('linux')

# Building information
options=('!buildflags')
source=("https://www.kernel.org/pub/linux/kernel/v4.x/${_srcname}.tar.xz"
        "https://www.kernel.org/pub/linux/kernel/v4.x/patch-${pkgver}.xz")
md5sums=('5276563eb1f39a048e4a8a887408c031'
         'c5f3473be15411f7b02f36b7f52cc9d1')

modules() {
    # true if modules are enabled, false otherwise
    grep ".config" -e 'CONFIG_MODULES=y' > /dev/null
    return "$?"
}

prepare() {
    cd "${srcdir}/${_srcname}"

    # Add upstream patch.
    patch -p1 -i "${srcdir}/patch-${pkgver}"

    # Set extraversion to pkgrel.
    sed -ri "s|^(EXTRAVERSION =).*|\1 -${pkgrel}|" Makefile

    # Clean up the kernel tree.
    make mrproper

    # Generate the default config.
    make allnoconfig ARCH="${_target_arch_alias}"

    # Pick a config that will work with qemu.
    case "${_target_arch}" in
        mips)
            # Generate the config.
            cat >> .config << EOF
CONFIG_MIPS_MALTA=y
CONFIG_CPU_BIG_ENDIAN=y
CONFIG_CPU_MIPS32_R2=y
CONFIG_PAGE_SIZE_16KB=y
CONFIG_MIPS_MT_SMP=y
CONFIG_HZ_100=y
CONFIG_NO_HZ=y
CONFIG_HIGH_RES_TIMERS=y
EOF

            # Currently the kernel will not build with -Werror; I haven't
            # figured out a way to neatly disable this, so sed it out of
            # the Kbuild file for mips.
            sed -i arch/mips/Kbuild -e '/subdir-ccflags-y/d'
            ;;
        i586)
            # Generate the config.
            cat >> .config << EOF
CONFIG_M586=y
EOF
            ;;
        *) make defconfig ARCH="${_target_arch_alias}";;
    esac

    # Enable standard options.
    cat >> .config << EOF
# Generic options.
CONFIG_PCI=y
CONFIG_PRINTK=y
CONFIG_TTY=y
CONFIG_SLOB=y
CONFIG_BINFMT_ELF=y
CONFIG_BINFMT_SCRIPT=y
CONFIG_CROSS_COMPILE="${_target_triplet}-"
CONFIG_DEFAULT_HOSTNAME="qemu"

# We don't enable this; it is broken on mips.
# TODO: Bug report?
#CONFIG_CC_OPTIMIZE_FOR_SIZE=y

# We use devtmp, sys, tmp, and proc filesystems.
# We also assume that devtmpfs is mounted.
CONFIG_PROC_FS=y
CONFIG_SYSFS=y
CONFIG_TMPFS=y
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y

# Enable serial; disable a graphical console.
# CONFIG_INPUT_KEYBOARD is not set
# CONFIG_INPUT_MOUSE is not set
# CONFIG_SERIO_I8042 is not set
CONFIG_SERIAL_8250=y
CONFIG_SERIAL_8250_CONSOLE=y
# CONFIG_HWMON is not set
# CONFIG_VGA_CONSOLE is not set

# Enable 9p and virtio.
CONFIG_VIRTIO=y
CONFIG_VIRTIO_RING=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_NET=y
CONFIG_INET=y
CONFIG_NET_9P=y
CONFIG_NET_9P_DEBUG=y
CONFIG_NET_9P_VIRTIO=y
CONFIG_9P_FS=y
CONFIG_9P_FS_POSIX_ACL=y

# Enable multiuser support (we need at least 'nobody' for builds).
CONFIG_MULTIUSER=y

# Enable block devices.
CONFIG_BLOCK=y
# CONFIG_LBDAF is not set
# CONFIG_BLK_DEV_BSG is not set
# CONFIG_IOSCHED_CFQ is not set
# CONFIG_IOSCHED_DEADLINE is not set

# Disable uneeded options.
# CONFIG_ETHERNET is not set
# CONFIG_INPUT_MOUSEDEV is not set
# CONFIG_HID is not set
# CONFIG_PCSPKR_PLATFORM is not set
# CONFIG_UNIX98_PTYS is not set
# CONFIG_LEGACY_PTYS is not set
EOF

    # Run oldconfig.
    yes '' | make oldconfig ARCH="${_target_arch_alias}"
}


build() {
    cd "${srcdir}/${_srcname}"

    # Make the kernel image and modules, if needed
    case "${_target_arch_alias}" in
        i386) targets="bzImage";;
        mips) targets="vmlinux";;
        *) targets="vmlinuz";;
    esac
    if modules; then
        # Modules are enabled
        targets+=" modules"
    fi

    make ${targets} ARCH="${_target_arch_alias}"
}


package() {
    # Main Linux kernel package
    cd "${srcdir}/${_srcname}"

    # Find the kernel version
    _kernver="$(make kernelrelease ARCH="${_target_arch_alias}")"

    # Make the boot directory
    mkdir -p "${pkgdir}/boot"

    # Copy the image to the end location
    if [ -e "arch/${_target_arch_alias}/boot/bzImage" ]; then
        cp "arch/${_target_arch_alias}/boot/bzImage" \
           "${pkgdir}/boot/vmlinuz"
    elif [ -e "vmlinuz" ]; then
        cp "vmlinuz" "${pkgdir}/boot/vmlinuz"
    else
        cp "vmlinux" "${pkgdir}/boot/vmlinuz"
    fi

    # Install the modules and firmware, if required
    if modules; then
        make INSTALL_MOD_PATH="${pkgdir}/usr" modules_install \
            ARCH="${_target_arch_alias}"
        # Remove the kernel source tree
        rm -f "${pkgdir}/usr/lib/modules/${_kernver}"/{source,build}
        # Add vmlinux
        install -D -m644 'vmlinux' \
            "${pkgdir}/usr/lib/modules/${_kernver}/build/vmlinux" 
    fi
}

# Maintainer: Alastair Hughes <hobbitalastiar at yandex dot org>
# Arch Linux maintainer: Tobias Powalowski <tpowa@archlinux.org>
# Arch Linux maintainer: Thomas Baechler <thomas@archlinux.org>

pkgname=linux               # Build stock -ARCH kernel
#pkgbase=linux-custom       # Build kernel with a different name
_srcname=linux-3.14
pkgver=3.14.1
pkgrel=1
pkgdesc="The ${pkgbase/linux/Linux} kernel and modules"
arch=('i586')
groups=('base')
url="http://www.kernel.org/"
license=('GPL2')
makedepends=('bc')
options=('!strip')

source=("https://www.kernel.org/pub/linux/kernel/v3.x/${_srcname}.tar.xz"
        "https://www.kernel.org/pub/linux/kernel/v3.x/patch-${pkgver}.xz"
        "config.${_name}"
        'linux-3.8-trap.patch'
        'linux-3.8-posix_sed.patch'
        )

md5sums=('b621207b3f6ecbb67db18b13258f8ea8'
         '2526eb95793ecc1c22d7e1428ef23cdc'
         'c03d3b9210dff5a6510206070c70c08b'
         'cb129da0e78dab88c8754dbe6e704aad'
         '19ab9d2a7a0baa416106a4432c19afdf')


_kernelname=${pkgbase#linux}

prepare() {
  cd "${srcdir}/${_srcname}"

  # add upstream patch
  patch -p1 -i "${srcdir}/patch-${pkgver}"

  # add latest fixes from stable queue, if needed
  # http://git.kernel.org/?p=linux/kernel/git/stable/stable-queue.git

  # set DEFAULT_CONSOLE_LOGLEVEL to 4 (same value as the 'quiet' kernel param)
  # remove this when a Kconfig knob is made available by upstream
  # (relevant patch sent upstream: https://lkml.org/lkml/2011/7/26/227)
  #patch -p1 -i "${srcdir}/change-default-console-loglevel.patch"

  cat "${srcdir}/config.${_name}" > ./.config

  if [ "${_kernelname}" != "" ]; then
    sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"${_kernelname}\"|g" ./.config
    sed -i "s|CONFIG_LOCALVERSION_AUTO=.*|CONFIG_LOCALVERSION_AUTO=n|" ./.config
  fi

  # set extraversion to pkgrel
  sed -ri "s|^(EXTRAVERSION =).*|\1 -${pkgrel}|" Makefile

  # don't run depmod on 'make install'. We'll do this ourselves in packaging
  sed -i '2iexit 0' scripts/depmod.sh

  for i in $srcdir/*.patch; do
    echo "Applying patch $i"
    patch -p1 <$i
  done

  # get kernel version
  #make prepare
  # Not needed?

  # load configuration
  # Configure the kernel. Replace the line below with one of your choice.
  #make menuconfig # CLI menu for configuration
  #make nconfig # new CLI menu for configuration
  #make xconfig # X-based configuration
  yes "" | make oldconfig # using old config from previous kernel version
  # ... or manually edit .config

  # rewrite configuration
  yes "" | make config >/dev/null
}

build() {
  cd "${srcdir}/${_srcname}"

  make bzImage
}

package() {
  cd "${srcdir}/${_srcname}"

  KARCH=x86

  mkdir -p "${pkgdir}"/boot
  cp arch/$KARCH/boot/bzImage "${pkgdir}/boot/vmlinuz-${pkgbase}"
}

# vim:set ts=8 sts=2 sw=2 et:

# Maintainer: Alastair Hughes < hobbitalastair at yandex dot com>

# Package information
pkgname='openssl'
_ver='1.1.0'
# use a pacman compatible version scheme
pkgver=${_ver/[a-z]/.${_ver//[0-9.]/}}
pkgrel=1
pkgdesc='The Open Source toolkit for Secure Sockets Layer and Transport Layer Security'

# Additional information...
arch=('mips' 'i586')
url='https://www.openssl.org'
license=('custom:BSD')

# Dependency information
makedepends=('zlib' 'musl' 'linux-api-headers')
hostdepends=('toolchain')
# optdepends=('perl: for c_rehash script'
#             'ca-certificates')

# Building information
backup=('etc/ssl/openssl.cnf')
options=('!makeflags')
source=("https://www.openssl.org/source/${pkgname}-${_ver}.tar.gz"
        'ca-dir.patch')
md5sums=('dbef70de4a1a4bdd78ab7c6547e5211d'
         '81a2fb21ea97050ad5efb96a697d627e')


prepare() {
    cd "${srcdir}/${pkgname}-${_ver}"

    # set ca dir to /etc/ssl by default
    patch -p0 -i "${srcdir}/ca-dir.patch"
}


build() {
    cd "${srcdir}/${pkgname}-${_ver}"

    if [ "${_target_arch_alias}" == 'x86_64' ]; then
        openssltarget='linux-x86_64'
        optflags='enable-ec_nistp_64_gcc_128'
    elif [ "${_target_arch_alias}" == 'i386' ]; then
        openssltarget='linux-elf'
        optflags=''
    elif [ "${_target_arch_alias}" == 'mips' ]; then
        openssltarget='linux-mips32'
        optflags=''
    fi

    # mark stack as non-executable: http://bugs.archlinux.org/task/12434
    ./Configure --prefix="/usr" \
        --openssldir="/etc/ssl" \
        --libdir="lib" \
        no-shared no-async zlib "${optflags}" \
        "${openssltarget}" \
        "-Wa,--noexecstack ${CFLAGS} ${LDFLAGS}"

    make
}


package() {
    cd "${srcdir}/${pkgname}-${_ver}"

    # We need PATH to include the perl directories for pod2man.
    PATH="${PATH}:/usr/bin/core_perl:/usr/bin/site_perl:/usr/bin/vendor_perl" \
    make DESTDIR="${pkgdir}/" \
        MANDIR="/usr/share/man" \
        MANSUFFIX='ssl' install
    install -D -m644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

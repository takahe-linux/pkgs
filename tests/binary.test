#!/usr/bin/bash

set -e
finish() { echo "Success!"; exit 0; }
fail() { printf "%s\n" "$1"; echo "Fail!"; exit 1; }

get_arch() {
    # Print the arch of the given binary.
    readelf -h "$1" | sed -n -e '/Machine:/p' | sed -e 's/.*:[ \t]*//'
}

arch="$(get_arch /usr/bin/busybox)"
for i in /usr/bin/* /usr/lib/*; do
    if [ -x "${i}" ]; then
        # Check arch.
        if [ "$(get_arch "${i}")" != "${arch}" ]; then
            fail "Got two different architectures: $(get_arch "${i}"), ${arch}!"
        fi
        # Check that this is not dynamically linked.
        readelf -d "${i}" | grep 'Shared library' && \
            fail "'${i}' is dynamically linked!"
        # Check that binaries are stripped.
        objdump -t "${i}" | grep 'debug' && \
            fail "'${i}' has debug information!"
    fi
done

finish
